# cloudflowPayments

Приложение, которое вычитывает файлы с переводами из заданной директории и запускает потоки выполнения платежей.

## Пример использования

В конфигурационном файле local.conf (/datamodel/src/main/resources/local.conf), укажите следующие обязательные свойства:
```
cloudflow {
	streamlets {
		ingestor {
			config-parameters {
		  		catalog = """C:\\Users\\danel\\Music\\files"""
		  		maskFile = """file[0-9]+.txt"""
			}
		}
	}
}
```

Пример перевода в считываемых файлах (по маске в конфигурационном файле, можно переопределить):
```
a1 -> a2 : 100
```

Запустите проект(см. ниже), инициализируйте участников платежа и добавляйте файлы с платежами в указанный вами каталог.
Для инициализации участников, необходимо импортировать коллекцию Postman(src/main/resources/initialial-state-http-processor.postman_collection.json) и запустить её.

## Запуск

Для локального запуска (например, на IntelliJ IDEA), необходимо иметь подготовленную среду для запуска Scala проектов.

Запустите **sbt shell**, дождитесь сообщения ```[IJ]sbt:cloudflowPayments>```, и введите: ```runLocal```

Дождитесь появления в консоли сообщения, в котором будет указана папка с выходными файлами стримлетов.
```
------------------------------------ Output ------------------------------------
Pipeline log output available in folder: "папка с выходными файлами"
--------------------------------------------------------------------------------
```


## Модули
- **FilePaymentsIngress** (Akka стримлет), вычитывает из каталога файлы по маске имени, и формирует "поток переводов" для передачи дальше по процессу;
- **ParticipantInitializeIngress** (Akka стримлет), принимает по REST JSON сообщение, содержащее идентификатор участника, стартовый баланс, валюту, и отправляет в стримлет **PaymentProcessingStreamlet**;
- **PaymentCheckingStreamlet** (Flink стримлет), принимает поток сообщений-переводов от **FilePaymentsIngress**, и, в случае не удовлетворения маске платежа, откидывает сообщение в стримлет **PaymentLoggingEgress**, а в случае валидного платежа формирует структурированное сообщение и передаёт в поток сообщений на обработку платежа в стримлет **PaymentProcessingStreamlet**;
- **PaymentLoggingEgress** (Akka стримлет), принимает сообщение на логгирование статуса, ошибок и пр. в консоль;
- **PaymentProcessingStreamlet** (Flink стримлет), принимает сообщения с возможными участниками переводов, и, в случае если участники будут найдены в Flink State, то проводит платёж, иначе формирует сообщение об ошибке в стримлет **PaymentLoggingEgress**.
